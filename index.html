<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chase the Ace - Display</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@300;400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Background Animation Container -->
    <div class="background-effects">
        <!-- Confetti generated by JS -->
    </div>

    <!-- Admin Link -->
    <a href="admin.html" class="admin-link">Admin</a>

    <!-- Slide Controls -->
    <div id="slide-controls">
        <button onclick="prevSlide()">&#10094;</button>
        <button onclick="togglePause()" id="pause-btn">&#10074;&#10074;</button>
        <button onclick="nextSlide()">&#10095;</button>
    </div>

    <!-- Main Slideshow Container -->
    <div id="slideshow-container">
        
        <!-- Slide 1: Main Title & Logo -->
        <!-- Slide 1: Main Title & Logo -->
        <div class="slide active" id="slide-main">
            <img src="logo.png" alt="Venue Logo" class="venue-logo" onerror="this.style.display='none'">
            <h1>CHASE THE ACE</h1>
            <img src="ace-of-spades.png" alt="Ace of Spades" class="ace-logo" onerror="this.style.display='none'">
            <h2>Join us for the Draw!</h2>
        </div>

        <!-- Slide 2: Current Jackpot -->
        <!-- Slide 2: Current Jackpot -->
        <div class="slide" id="slide-jackpot">
            <h2>CURRENT JACKPOT</h2>
            <div class="jackpot-amount" id="display-jackpot">$0.00</div>
            <p>Jackpot increases by $100 after every draw!</p>
        </div>

        <!-- Slide: Countdown (Only shows between 4pm and draw time) -->
        <div class="slide" id="countdown-slide">
            <h2>DRAW STARTS IN</h2>
            <div class="countdown-timer" id="timer-display">00:00:00</div>
            <div class="countdown-label">GET YOUR TICKETS NOW!</div>
        </div>

        <!-- Slide: Next Draw General Countdown -->
        <div class="slide" id="next-draw-slide">
            <h2>NEXT DRAW IN</h2>
            <div class="countdown-timer" id="next-draw-timer">00d 00:00:00</div>
            <div class="countdown-label" id="next-draw-label">LOADING...</div>
        </div>

        <!-- Slide 3: Tuesday Rules -->
        <!-- Slide 3: Tuesday Rules -->
        <div class="slide" id="slide-tuesday">
            <h2>TUESDAY DRAW</h2>
            <div class="time-box">
                <h3>Draw Time: 5:30 PM</h3>
            </div>

            <ul class="rules-list">
                <li>Purchase a beverage between <strong>3:00 PM - 5:30 PM</strong></li>
                <li>Receive a ticket for every drink purchased</li>
                <li>Be here for the draw to win!</li>
            </ul>
        </div>

        <!-- Slide 4: Saturday Rules -->
        <!-- Slide 4: Saturday Rules -->
        <div class="slide" id="slide-saturday">
            <h2>SATURDAY DRAW</h2>
            <div class="time-box">
                <h3>Draw Time: 6:30 PM</h3>
            </div>

            <ul class="rules-list">
                <li>Purchase a beverage between <strong>3:00 PM - 6:30 PM</strong></li>
                <li>Receive a ticket for every drink purchased</li>
                <li>Be here for the draw to win!</li>
            </ul>
        </div>

        <!-- Slide 5: How to Win -->
        <!-- Slide 5: How to Win -->
        <div class="slide" id="slide-win">
            <h2>HOW TO WIN</h2>
            <p>If your ticket is pulled from the barrel:</p>
            <div class="step-box">
                <p>1. Pick a card from the cabinet (52 Cards)</p>
                <p>2. Flip the <strong>ACE OF SPADES</strong></p>
                <p>3. WIN THE JACKPOT!</p>
            </div>
        </div>

    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
    </div>

    <script>
        // --- Configuration ---
        const slideDuration = 15000; // 15 seconds per slide

        // --- Slideshow Logic ---
        let currentSlide = 0;
        const slides = document.querySelectorAll('.slide');
        let isCountdownActive = false;
        let isPaused = false;
        let slideInterval;

        function prevSlide() {
            slides[currentSlide].classList.remove('active');
            let loopCount = 0;
            do {
                currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                loopCount++;
                if (loopCount > slides.length) break;
            } while (
                (slides[currentSlide].id === 'countdown-slide' && !isCountdownActive) ||
                (slides[currentSlide].id === 'next-draw-slide' && isCountdownActive)
            );
            slides[currentSlide].classList.add('active');
            resetProgressBar();
            resetInterval();
        }

        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pause-btn');
            if (isPaused) {
                clearInterval(slideInterval);
                btn.innerHTML = '&#9658;'; // Play icon
                document.getElementById('progress-bar').style.animationPlayState = 'paused';
            } else {
                resetInterval();
                btn.innerHTML = '&#10074;&#10074;'; // Pause icon
                document.getElementById('progress-bar').style.animationPlayState = 'running';
            }
        }

        function resetInterval() {
            clearInterval(slideInterval);
            if (!isPaused) {
                slideInterval = setInterval(nextSlide, slideDuration);
            }
        }

        function nextSlide() {
            // Remove active class from current
            slides[currentSlide].classList.remove('active');
            
            // Find next valid slide (skip countdown if not active)
            let loopCount = 0;
            do {
                currentSlide = (currentSlide + 1) % slides.length;
                loopCount++;
                if (loopCount > slides.length) break; // Safety break
            } while (
                (slides[currentSlide].id === 'countdown-slide' && !isCountdownActive) ||
                (slides[currentSlide].id === 'next-draw-slide' && isCountdownActive)
            );
            
            // Add active class to next
            slides[currentSlide].classList.add('active');
            
            // Reset Progress Bar Animation
            resetProgressBar();
        }

        function resetProgressBar() {
            const bar = document.getElementById('progress-bar');
            bar.style.animation = 'none';
            bar.offsetHeight; /* Trigger reflow */
            bar.style.animation = `progress ${slideDuration}ms linear`;
        }

        // Start the rotation
        resetProgressBar();
        // Start the rotation
        resetProgressBar();
        resetInterval();

        // --- Jackpot Logic ---
        // TODO: Paste your Google Sheet CSV URL here inside the quotes
        // Example: "https://docs.google.com/spreadsheets/d/e/2PACX-.../pub?output=csv"
        const googleSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTWKQ868KUAuJv03Z4ULML1XtCTp7aJ8066j17W5pAYpT9yTj0foQt-PMa3aJCViFC6pzKX3jZU8pnk/pub?output=csv"; 

        async function updateJackpotDisplay() {
            const displayEl = document.getElementById('display-jackpot');
            
            // Fallback to local storage if URL isn't set yet
            if (!googleSheetUrl) {
                const storedAmount = localStorage.getItem('cta_jackpot');
                if (storedAmount) displayEl.innerText = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'NZD' }).format(storedAmount);
                else if (displayEl.innerText === "$0.00") displayEl.innerText = "$500.00";
                return;
            }

            try {
                // Fetch data from Google Sheets (adding timestamp to prevent caching)
                const response = await fetch(googleSheetUrl + '&t=' + Date.now());
                const text = await response.text();
                
                // Clean the text to get just the number
                const amount = parseFloat(text.replace(/[^0-9.]/g, ''));
                
                if (!isNaN(amount)) {
                    displayEl.innerText = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
                }
            } catch (e) { console.error("Error fetching jackpot:", e); }
        }

        // Check for jackpot updates every 5 seconds (in case admin updates it)
        updateJackpotDisplay();
        setInterval(updateJackpotDisplay, 60000);

        // --- Countdown Logic (NZ Time) ---
        function updateCountdown() {
            const now = new Date();
            // Create date object based on NZ time
            const nzTimeStr = now.toLocaleString("en-US", {timeZone: "Pacific/Auckland"});
            const nzDate = new Date(nzTimeStr);
            
            const day = nzDate.getDay(); // 0=Sun, 1=Mon, 2=Tue... 6=Sat
            const hours = nzDate.getHours();
            const minutes = nzDate.getMinutes();
            
            let target = null;
            
            // Tuesday (Day 2): Active 4:00 PM (16:00) to 5:30 PM (17:30)
            if (day === 2 && (hours >= 16 && (hours < 17 || (hours === 17 && minutes < 30)))) {
                target = new Date(nzDate);
                target.setHours(17, 30, 0, 0);
            }
            
            // Saturday (Day 6): Active 4:00 PM (16:00) to 6:30 PM (18:30)
            if (day === 6 && (hours >= 16 && (hours < 18 || (hours === 18 && minutes < 30)))) {
                target = new Date(nzDate);
                target.setHours(18, 30, 0, 0);
            }

            if (target) {
                isCountdownActive = true;
                const diff = target - nzDate;
                
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                
                document.getElementById('timer-display').innerText = 
                    (h < 10 ? "0" + h : h) + ":" + (m < 10 ? "0" + m : m) + ":" + (s < 10 ? "0" + s : s);
            } else {
                isCountdownActive = false;
            }
        }
        setInterval(updateCountdown, 1000);
        updateCountdown();

        // --- Rule Page Timers (Tuesday/Saturday specific) ---
        // --- Rule Page Timers (Tuesday/Saturday specific) ---
        // --- Global Next Draw Countdown Logic ---
        function updateNextDrawTimer() {
            const now = new Date();
            const nzTimeStr = now.toLocaleString("en-US", {timeZone: "Pacific/Auckland"});
            const nzDate = new Date(nzTimeStr);

            // Define Draw Times: Tue 17:30 (Day 2), Sat 18:30 (Day 6)
            function getNextOccurrence(dayIndex, hours, minutes) {
                let target = new Date(nzDate);
                target.setHours(hours, minutes, 0, 0);
                
                if (nzDate.getDay() === dayIndex) {
                    if (nzDate.getTime() >= target.getTime()) {
                        target.setDate(target.getDate() + 7);
                    }
                } else {
                    let daysUntil = (dayIndex + 7 - nzDate.getDay()) % 7;
                    target.setDate(target.getDate() + daysUntil);
                }
                return target;
            }

            const nextTue = getNextOccurrence(2, 17, 30);
            const nextSat = getNextOccurrence(6, 18, 30);

            // Determine which is closer
            let target;
            let labelText;
            
            if (nextTue < nextSat) {
                target = nextTue;
                labelText = "TUESDAY DRAW";
            } else {
                target = nextSat;
                labelText = "SATURDAY DRAW";
            }

            // Calculate Diff
            const diff = target - nzDate;
            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);

            // Update DOM
            document.getElementById('next-draw-timer').innerText = 
                `${d}d ${h < 10 ? '0'+h : h}:${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
            document.getElementById('next-draw-label').innerText = labelText;
        }

        setInterval(updateNextDrawTimer, 1000);
        setInterval(updateNextDrawTimer, 1000);
        updateNextDrawTimer();

        // --- Slide Text Size Logic ---
        function updateSlideSizes() {
            const storedSizes = localStorage.getItem('cta_slide_sizes');
            if (storedSizes) {
                const sizes = JSON.parse(storedSizes);
                const slideMap = {
                    'main': 'slide-main',
                    'jackpot': 'slide-jackpot',
                    'countdown': 'countdown-slide',
                    'next-draw': 'next-draw-slide',
                    'tuesday': 'slide-tuesday',
                    'saturday': 'slide-saturday',
                    'win': 'slide-win'
                };

                for (const [key, id] of Object.entries(slideMap)) {
                    if (sizes[key]) {
                        const el = document.getElementById(id);
                        if (el) {
                            // Default is 1rem, so percentage / 100 = rem value
                            el.style.fontSize = (sizes[key] / 100) + 'rem';
                        }
                    }
                }
            }
        }
        
        // Check for size updates every 2 seconds
        updateSlideSizes();
        setInterval(updateSlideSizes, 2000);

        // --- Generate Effective Confetti ---
        const confettiContainer = document.querySelector('.background-effects');
        for (let i = 0; i < 50; i++) {
            const el = document.createElement('div');
            el.classList.add('confetti');
            el.innerText = 'â™ ';
            el.style.left = Math.random() * 100 + '%';
            el.style.animationDuration = (Math.random() * 5 + 5) + 's'; // 5-10s duration
            el.style.animationDelay = (Math.random() * 5) + 's'; // 0-5s delay
            el.style.fontSize = (Math.random() * 4 + 4) + 'rem'; // 4rem to 8rem range
            el.style.opacity = Math.random() * 0.5 + 0.3;
            confettiContainer.appendChild(el);
        }
    </script>
</body>
</html>
